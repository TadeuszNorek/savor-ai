import{j as e}from"./createLucideIcon.Dkxjm4wi.js";import{r as u}from"./index.BkdHoFEG.js";import{S as O,c as U,d as $,e as q,f as w,B as K,X as Q,o as Y,q as G,r as H,g as v,t as j,p as W,T as X}from"./sonner.hCFXhOXH.js";import{g as J,I as Z}from"./Combination.X7r7J2UN.js";import{B as ee,s as E}from"./supabase.client.D2OLuBHL.js";import{I as re,C as ie,a as se,b as te,c as ne,d as ae,L as P,A,f as D,g as _,e as R}from"./label.Di0WFfjI.js";import"./index.yjdR7O-I.js";function le(r){return{dietType:r.diet_type??null,dislikedIngredients:r.disliked_ingredients??[],preferredCuisines:r.preferred_cuisines??[]}}function de(){return{dietType:null,dislikedIngredients:[],preferredCuisines:[]}}function oe(r){const i={};return r.dietType&&(i.diet_type=r.dietType),r.dislikedIngredients.length>0&&(i.disliked_ingredients=r.dislikedIngredients),r.preferredCuisines.length>0&&(i.preferred_cuisines=r.preferredCuisines),i}function ce(r,i){const t={};return r.dietType!==i.dietType&&(t.diet_type=r.dietType),I(r.dislikedIngredients,i.dislikedIngredients)||(t.disliked_ingredients=r.dislikedIngredients),I(r.preferredCuisines,i.preferredCuisines)||(t.preferred_cuisines=r.preferredCuisines),t}function V(r){const i=r.map(t=>t.trim().toLowerCase()).filter(t=>t.length>0);return Array.from(new Set(i))}function F(r){return r.dietType!==null||r.dislikedIngredients.length>0||r.preferredCuisines.length>0}function ue(r,i){return r.dietType!==i.dietType||!I(r.dislikedIngredients,i.dislikedIngredients)||!I(r.preferredCuisines,i.preferredCuisines)}function I(r,i){if(r.length!==i.length)return!1;const t=[...r].sort(),n=[...i].sort();return t.every((o,s)=>o===n[s])}const fe=[{value:"vegan",label:"Vegan"},{value:"vegetarian",label:"Vegetarian"},{value:"pescatarian",label:"Pescatarian"},{value:"keto",label:"Keto"},{value:"paleo",label:"Paleo"},{value:"gluten_free",label:"Gluten Free"},{value:"dairy_free",label:"Dairy Free"},{value:"low_carb",label:"Low Carb"},{value:"mediterranean",label:"Mediterranean"},{value:"omnivore",label:"Omnivore"}],B=u.forwardRef(({value:r,onChange:i,"aria-invalid":t,"aria-describedby":n},o)=>{const s=a=>{i(a==="none"?null:a)};return e.jsxs(O,{value:r||"none",onValueChange:s,children:[e.jsx(U,{id:"dietType",className:"w-full",ref:o,"aria-invalid":t,"aria-describedby":n,children:e.jsx($,{placeholder:"Select a diet type"})}),e.jsxs(q,{children:[e.jsx(w,{value:"none",children:"None"}),fe.map(a=>e.jsx(w,{value:a.value,children:a.label},a.value))]})]})});B.displayName="DietTypeSelect";const S=u.forwardRef(({name:r,value:i,onChange:t,placeholder:n,"aria-invalid":o,"aria-describedby":s},a)=>{const[f,y]=u.useState(""),g=l=>{const h=l.trim();if(h.length===0||h.length>50)return;const C=h.toLowerCase();if(i.some(T=>T.toLowerCase()===C)){y("");return}t([...i,C]),y("")},c=l=>{t(i.filter((h,C)=>C!==l))},m=l=>{l.key==="Enter"||l.key===","?(l.preventDefault(),g(f)):l.key==="Backspace"&&f===""&&i.length>0&&c(i.length-1)},b=()=>{f.trim()&&g(f)},k=i.length>=100;return e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{id:r,type:"text",value:f,onChange:l=>y(l.target.value),onKeyDown:m,onBlur:b,placeholder:k?"Maximum limit reached":n,disabled:k,className:"w-full",ref:a,"aria-invalid":o,"aria-describedby":s,role:"textbox","aria-label":`Add ${r==="dislikedIngredients"?"disliked ingredients":"preferred cuisines"}`}),i.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",role:"list","aria-label":"Selected items",children:i.map((l,h)=>e.jsxs(K,{variant:"secondary",className:"gap-1 pl-2 pr-1",role:"listitem",children:[e.jsx("span",{children:l}),e.jsx("button",{type:"button",onClick:()=>c(h),className:"ml-1 hover:bg-muted rounded-sm p-0.5","aria-label":`Remove ${l}`,children:e.jsx(Q,{className:"h-3 w-3","aria-hidden":"true"})})]},`${l}-${h}`))}),e.jsxs("p",{className:"text-xs text-muted-foreground","aria-live":"polite",children:["Press Enter or comma to add. ",i.length,"/100 items."]})]})});S.displayName="TagsInput";function pe({initialValues:r,mode:i,onSubmit:t}){const[n,o]=u.useState(r),[s,a]=u.useState({}),[f,y]=u.useState(!1),{lang:g}=J(),c=u.useRef(null),m=u.useRef(null),b=u.useRef(null),k=u.useRef(null);u.useEffect(()=>{o(r)},[r]);const l=()=>{const d={};if(!F(n))return d.dietType="At least one field must be filled",a(d),!1;n.dislikedIngredients.length>100&&(d.dislikedIngredients="Maximum 100 ingredients allowed");for(const p of n.dislikedIngredients)if(p.length>50){d.dislikedIngredients="Each ingredient must be 50 characters or less";break}n.preferredCuisines.length>100&&(d.preferredCuisines="Maximum 100 cuisines allowed");for(const p of n.preferredCuisines)if(p.length>50){d.preferredCuisines="Each cuisine must be 50 characters or less";break}return a(d),Object.keys(d).length===0},h=async d=>{if(d.preventDefault(),!l()){s.dietType?c.current?.focus():s.dislikedIngredients?m.current?.focus():s.preferredCuisines&&b.current?.focus();return}y(!0);try{await t(n)}finally{y(!1)}},C=d=>{o(p=>({...p,dietType:d})),a(p=>({...p,dietType:void 0}))},T=d=>{const p=V(d);o(x=>({...x,dislikedIngredients:p})),a(x=>({...x,dislikedIngredients:void 0}))},L=d=>{const p=V(d);o(x=>({...x,preferredCuisines:p})),a(x=>({...x,preferredCuisines:void 0}))},M=ue(n,r),N=F(n),z=N&&(i==="create"||M)&&!f;return e.jsx("form",{onSubmit:h,ref:k,"aria-label":"Profile preferences form",children:e.jsxs(ie,{children:[e.jsxs(se,{children:[e.jsx(te,{children:i==="create"?"Create Profile":"Edit Profile"}),e.jsx(ne,{children:i==="create"?"Set up your dietary preferences to get started.":"Update your dietary preferences to refine your recommendations."})]}),e.jsxs(ae,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"dietType",children:"Diet Type (Optional)"}),e.jsx(B,{value:n.dietType,onChange:C,ref:c,"aria-invalid":!!s.dietType,"aria-describedby":s.dietType?"dietType-error":"dietType-helper"}),s.dietType&&e.jsx("p",{id:"dietType-error",className:"text-sm text-destructive",role:"alert",children:s.dietType}),e.jsx("p",{id:"dietType-helper",className:"text-sm text-muted-foreground",children:"Select your dietary preference to filter recipes accordingly."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"dislikedIngredients",children:"Disliked Ingredients (Optional)"}),e.jsx(S,{name:"dislikedIngredients",value:n.dislikedIngredients,onChange:T,placeholder:"Add ingredients you want to avoid...",ref:m,"aria-invalid":!!s.dislikedIngredients,"aria-describedby":s.dislikedIngredients?"dislikedIngredients-error":"dislikedIngredients-helper"}),s.dislikedIngredients&&e.jsx("p",{id:"dislikedIngredients-error",className:"text-sm text-destructive",role:"alert",children:s.dislikedIngredients}),e.jsxs("p",{id:"dislikedIngredients-helper",className:"text-sm text-muted-foreground",children:["Recipes containing these ingredients will be blocked from saving."," ",e.jsxs("strong",{className:"text-foreground",children:["Enter in ",g==="pl"?"Polish":"English"," (current UI language)."]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"preferredCuisines",children:"Preferred Cuisines (Optional)"}),e.jsx(S,{name:"preferredCuisines",value:n.preferredCuisines,onChange:L,placeholder:"Add cuisines you enjoy...",ref:b,"aria-invalid":!!s.preferredCuisines,"aria-describedby":s.preferredCuisines?"preferredCuisines-error":"preferredCuisines-helper"}),s.preferredCuisines&&e.jsx("p",{id:"preferredCuisines-error",className:"text-sm text-destructive",role:"alert",children:s.preferredCuisines}),e.jsxs("p",{id:"preferredCuisines-helper",className:"text-sm text-muted-foreground",children:["We'll prioritize recipes from these cuisines in your recommendations."," ",e.jsxs("strong",{className:"text-foreground",children:["Enter in ",g==="pl"?"Polish":"English"," (current UI language)."]})]})]}),!N&&e.jsx("div",{className:"text-sm text-destructive",role:"alert","aria-live":"polite",children:"Please fill in at least one field to save your profile."}),e.jsx(ee,{type:"submit",disabled:!z,className:"w-full","aria-label":f?"Saving profile":i==="create"?"Create profile":"Save changes to profile",children:f?"Saving...":i==="create"?"Create Profile":"Save Changes"})]})]})})}function me(){const{data:r,isLoading:i,error:t}=Y(),n=G(),o=H(),s=r?"update":"create",a=r?le(r):de();if(i)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(v,{className:"h-12 w-full"}),e.jsx(v,{className:"h-12 w-full"}),e.jsx(v,{className:"h-12 w-full"}),e.jsx(v,{className:"h-10 w-32"})]});const f=async g=>{try{if(s==="create"){const c=oe(g);console.log("[ProfileView] Creating profile with command:",c),await n.mutateAsync(c),j.success("Profile created successfully!")}else{const c=ce(g,a);if(console.log("[ProfileView] Updating profile with command:",c),console.log("[ProfileView] Current values:",g),console.log("[ProfileView] Initial values:",a),Object.keys(c).length===0){j.info("No changes to save");return}await o.mutateAsync(c),j.success("Profile updated successfully!")}}catch(c){const m=c;if(m.error==="Conflict"){j.error("Profile already exists. Please refresh the page.");return}if(m.error==="Bad Request"||m.message==="Validation failed"){j.error(m.message||"Validation error. Please check your input.");return}j.error(m.message||"An error occurred. Please try again.")}};if(t&&t.error!=="Not Found")return e.jsxs(A,{variant:"destructive",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx(_,{children:"Error"}),e.jsx(R,{children:t.message||"Failed to load profile. Please try again."})]});const y=n.isPending||o.isPending;return e.jsxs("div",{className:"space-y-6",children:[s==="create"&&e.jsxs(A,{children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx(_,{children:"Create Your Profile"}),e.jsx(R,{children:"Set up your dietary preferences to get personalized recipe recommendations."})]}),e.jsx(pe,{initialValues:a,mode:s,onSubmit:f}),y&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Saving..."})]})}function ke(){const[r,i]=u.useState(null);return u.useEffect(()=>{E.auth.getSession().then(({data:{session:n}})=>{i(n?.access_token??null)});const{data:{subscription:t}}=E.auth.onAuthStateChange((n,o)=>{i(o?.access_token??null)});return()=>t.unsubscribe()},[]),e.jsx(Z,{authToken:r,children:e.jsxs(W,{children:[e.jsx(me,{}),e.jsx(X,{})]})})}export{ke as default};
