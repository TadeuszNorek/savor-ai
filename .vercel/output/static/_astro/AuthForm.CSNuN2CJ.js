import{j as s}from"./createLucideIcon.Dkxjm4wi.js";import{r as l}from"./index.BkdHoFEG.js";import{C as k,a as L,b as T,c as V,d as z,A as W,f as M,e as q}from"./label.Di0WFfjI.js";import{B as H,s as g}from"./supabase.client.D2OLuBHL.js";import{E as U}from"./EmailInput.BWulBbGa.js";import{P as $}from"./PasswordInput.p3a-TrsH.js";import{h as j,b as x,n as G}from"./validation.RUTJejl8.js";import{s as C}from"./telemetry.C471PJLg.js";import"./index.yjdR7O-I.js";function se({initialMode:F="login"}){const[f,E]=l.useState(F),[r,S]=l.useState({email:"",password:""}),[d,o]=l.useState({}),[c,v]=l.useState(!1),[u,p]=l.useState({email:!1,password:!1}),y=l.useRef(null),A=l.useRef(null),P=a=>{S(e=>({...e,email:a})),u.email&&o(e=>({...e,email:void 0}))},N=a=>{S(e=>({...e,password:a})),u.password&&o(e=>({...e,password:void 0}))},I=()=>{p(e=>({...e,email:!0}));const a=x({...r}).email;o(e=>({...e,email:a}))},R=()=>{p(e=>({...e,password:!0}));const a=x({...r}).password;o(e=>({...e,password:a}))},B=async a=>{a.preventDefault(),console.log("[AuthForm] Submit started, mode:",f),p({email:!0,password:!0});const e=x(r);if(o(e),console.log("[AuthForm] Validation errors:",e),j(e)){console.log("[AuthForm] Validation failed, stopping"),e.email?y.current?.focus():e.password&&A.current?.focus();return}v(!0),console.log("[AuthForm] Starting auth request...");const w=G(r.email);console.log("[AuthForm] Normalized email:",w);try{if(f==="login"){console.log("[AuthForm] Calling signInWithPassword...");const{data:m,error:n}=await g.auth.signInWithPassword({email:w,password:r.password});if(console.log("[AuthForm] signInWithPassword response:",{data:!!m,error:n?.message}),n){let i="Login failed";n.message.includes("Invalid login credentials")?i="Invalid email or password":n.message.includes("Email not confirmed")?i="Please verify your email address":n.message.includes("rate")&&(i="Too many attempts. Please try again later"),console.log("[AuthForm] Login error:",i),o({form:i});return}console.log("[AuthForm] Login successful, waiting for session..."),await new Promise(i=>setTimeout(i,100));const{data:h}=await g.auth.getSession();if(console.log("[AuthForm] Session check:",{hasSession:!!h.session}),!h.session){console.log("[AuthForm] Session not available!"),o({form:"Session error. Please try again."});return}console.log("[AuthForm] Sending telemetry..."),C().catch(()=>{}),console.log("[AuthForm] Redirecting to /app"),window.location.href="/app"}else{const{error:m}=await g.auth.signUp({email:w,password:r.password});if(m){o({form:m.message||"Registration failed"});return}await new Promise(h=>setTimeout(h,100));const{data:n}=await g.auth.getSession();if(!n.session){o({form:"Session error. Please try again."});return}C().catch(()=>{}),window.location.href="/app"}}catch(m){console.error("[AuthForm] Caught error:",m),o({form:"Network error. Please check your connection and try again."})}finally{console.log("[AuthForm] Submit finished"),v(!1)}},b=()=>{E(a=>a==="login"?"register":"login"),o({})},t=f==="login",D=!j(d);return s.jsxs(k,{className:"w-full max-w-md mx-auto",children:[s.jsxs(L,{children:[s.jsx(T,{children:t?"Sign In":"Create Account"}),s.jsx(V,{children:t?"Enter your email and password to sign in":"Enter your email and password to create an account"})]}),s.jsx(z,{children:s.jsxs("form",{onSubmit:B,className:"space-y-4","aria-label":`${t?"Login":"Registration"} form`,children:[d.form&&s.jsxs(W,{variant:d.form.includes("ready")?"default":"destructive",children:[s.jsx(M,{className:"h-4 w-4"}),s.jsx(q,{children:d.form})]}),s.jsx(U,{ref:y,value:r.email,onChange:P,onBlur:I,error:u.email?d.email:void 0,disabled:c}),s.jsx($,{ref:A,value:r.password,onChange:N,onBlur:R,error:u.password?d.password:void 0,disabled:c,label:t?"Password":"Password (min. 8 characters)"}),s.jsx(H,{type:"submit",className:"w-full",disabled:c||!D,"aria-label":t?"Sign in":"Create account",children:c?"Processing...":t?"Sign In":"Create Account"}),t&&s.jsx("div",{className:"text-center text-sm",children:s.jsx("a",{href:"/auth/forgot",className:"text-muted-foreground hover:text-primary hover:underline",children:"Forgot your password?"})}),s.jsx("div",{className:"text-center text-sm",children:t?s.jsxs("p",{children:["Don't have an account?"," ",s.jsx("button",{type:"button",onClick:b,className:"text-primary hover:underline font-medium",disabled:c,children:"Sign up"})]}):s.jsxs("p",{children:["Already have an account?"," ",s.jsx("button",{type:"button",onClick:b,className:"text-primary hover:underline font-medium",disabled:c,children:"Sign in"})]})})]})})]})}export{se as AuthForm};
