import{j as e}from"./createLucideIcon.Dkxjm4wi.js";import{r as u}from"./index.BkdHoFEG.js";import{S as O,c as q,d as $,e as K,f as S,B as U,X as Q,o as Y,q as G,r as X,g as T,t as j,p as J,T as W}from"./sonner.CvGtvIeo.js";import{g as Z,I as ee}from"./Combination.MfsThBZB.js";import{B as re,s as D}from"./supabase.client.D2OLuBHL.js";import{I as ie,C as se,a as te,b as ne,c as ae,d as le,L as N,A as _,f as A,g as E,e as R}from"./label.Di0WFfjI.js";import"./index.yjdR7O-I.js";function de(r){return{dietType:r.diet_type??null,dislikedIngredients:r.disliked_ingredients??[],preferredCuisines:r.preferred_cuisines??[]}}function oe(){return{dietType:null,dislikedIngredients:[],preferredCuisines:[]}}function ce(r){const i={};return r.dietType&&(i.diet_type=r.dietType),r.dislikedIngredients.length>0&&(i.disliked_ingredients=r.dislikedIngredients),r.preferredCuisines.length>0&&(i.preferred_cuisines=r.preferredCuisines),i}function ue(r,i){const n={};return r.dietType!==i.dietType&&(n.diet_type=r.dietType),v(r.dislikedIngredients,i.dislikedIngredients)||(n.disliked_ingredients=r.dislikedIngredients),v(r.preferredCuisines,i.preferredCuisines)||(n.preferred_cuisines=r.preferredCuisines),n}function L(r){const i=r.map(n=>n.trim().toLowerCase()).filter(n=>n.length>0);return Array.from(new Set(i))}function B(r){return r.dietType!==null||r.dislikedIngredients.length>0||r.preferredCuisines.length>0}function fe(r,i){return r.dietType!==i.dietType||!v(r.dislikedIngredients,i.dislikedIngredients)||!v(r.preferredCuisines,i.preferredCuisines)}function v(r,i){if(r.length!==i.length)return!1;const n=[...r].sort(),a=[...i].sort();return n.every((c,t)=>c===a[t])}const pe=[{value:"vegan",label:"Vegan"},{value:"vegetarian",label:"Vegetarian"},{value:"pescatarian",label:"Pescatarian"},{value:"keto",label:"Keto"},{value:"paleo",label:"Paleo"},{value:"gluten_free",label:"Gluten Free"},{value:"dairy_free",label:"Dairy Free"},{value:"low_carb",label:"Low Carb"},{value:"mediterranean",label:"Mediterranean"},{value:"omnivore",label:"Omnivore"}],F=u.forwardRef(({value:r,onChange:i,"aria-invalid":n,"aria-describedby":a},c)=>{const t=l=>{i(l==="none"?null:l)};return e.jsxs(O,{value:r||"none",onValueChange:t,children:[e.jsx(q,{id:"dietType",className:"w-full",ref:c,"aria-invalid":n,"aria-describedby":a,children:e.jsx($,{placeholder:"Select a diet type"})}),e.jsxs(K,{children:[e.jsx(S,{value:"none",children:"None"}),pe.map(l=>e.jsx(S,{value:l.value,children:l.label},l.value))]})]})});F.displayName="DietTypeSelect";const w=u.forwardRef(({name:r,value:i,onChange:n,placeholder:a,"aria-invalid":c,"aria-describedby":t},l)=>{const[f,h]=u.useState(""),x=d=>{const g=d.trim();if(g.length===0||g.length>50)return;const C=g.toLowerCase();if(i.some(I=>I.toLowerCase()===C)){h("");return}n([...i,C]),h("")},s=d=>{n(i.filter((g,C)=>C!==d))},m=d=>{d.key==="Enter"||d.key===","?(d.preventDefault(),x(f)):d.key==="Backspace"&&f===""&&i.length>0&&s(i.length-1)},k=()=>{f.trim()&&x(f)},b=i.length>=100;return e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{id:r,type:"text",value:f,onChange:d=>h(d.target.value),onKeyDown:m,onBlur:k,placeholder:b?"Maximum limit reached":a,disabled:b,className:"w-full",ref:l,"aria-invalid":c,"aria-describedby":t,role:"textbox","aria-label":`Add ${r==="dislikedIngredients"?"disliked ingredients":"preferred cuisines"}`}),i.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",role:"list","aria-label":"Selected items",children:i.map((d,g)=>e.jsxs(U,{variant:"secondary",className:"gap-1 pl-2 pr-1",role:"listitem",children:[e.jsx("span",{children:d}),e.jsx("button",{type:"button",onClick:()=>s(g),className:"ml-1 hover:bg-muted rounded-sm p-0.5","aria-label":`Remove ${d}`,children:e.jsx(Q,{className:"h-3 w-3","aria-hidden":"true"})})]},`${d}-${g}`))}),e.jsxs("p",{className:"text-xs text-muted-foreground","aria-live":"polite",children:["Press Enter or comma to add. ",i.length,"/100 items."]})]})});w.displayName="TagsInput";function me({initialValues:r,mode:i,onSubmit:n}){const[a,c]=u.useState(r),[t,l]=u.useState({}),[f,h]=u.useState(!1),{lang:x,t:s}=Z(),m=u.useRef(null),k=u.useRef(null),b=u.useRef(null),d=u.useRef(null);u.useEffect(()=>{c(r)},[r]);const g=()=>{const o={};if(!B(a))return o.dietType="At least one field must be filled",l(o),!1;a.dislikedIngredients.length>100&&(o.dislikedIngredients="Maximum 100 ingredients allowed");for(const p of a.dislikedIngredients)if(p.length>50){o.dislikedIngredients="Each ingredient must be 50 characters or less";break}a.preferredCuisines.length>100&&(o.preferredCuisines="Maximum 100 cuisines allowed");for(const p of a.preferredCuisines)if(p.length>50){o.preferredCuisines="Each cuisine must be 50 characters or less";break}return l(o),Object.keys(o).length===0},C=async o=>{if(o.preventDefault(),!g()){t.dietType?m.current?.focus():t.dislikedIngredients?k.current?.focus():t.preferredCuisines&&b.current?.focus();return}h(!0);try{await n(a)}finally{h(!1)}},I=o=>{c(p=>({...p,dietType:o})),l(p=>({...p,dietType:void 0}))},V=o=>{const p=L(o);c(y=>({...y,dislikedIngredients:p})),l(y=>({...y,dislikedIngredients:void 0}))},M=o=>{const p=L(o);c(y=>({...y,preferredCuisines:p})),l(y=>({...y,preferredCuisines:void 0}))},z=fe(a,r),P=B(a),H=P&&(i==="create"||z)&&!f;return e.jsx("form",{onSubmit:C,ref:d,"aria-label":"Profile preferences form",children:e.jsxs(se,{children:[e.jsxs(te,{children:[e.jsx(ne,{children:s(i==="create"?"profile.createTitle":"profile.editTitle")}),e.jsx(ae,{children:s(i==="create"?"profile.createDescription":"profile.editDescription")})]}),e.jsxs(le,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"dietType",children:s("profile.dietTypeLabel")}),e.jsx(F,{value:a.dietType,onChange:I,ref:m,"aria-invalid":!!t.dietType,"aria-describedby":t.dietType?"dietType-error":"dietType-helper"}),t.dietType&&e.jsx("p",{id:"dietType-error",className:"text-sm text-destructive",role:"alert",children:t.dietType}),e.jsx("p",{id:"dietType-helper",className:"text-sm text-muted-foreground",children:s("profile.dietTypeHelper")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"dislikedIngredients",children:s("profile.dislikedIngredientsLabel")}),e.jsx(w,{name:"dislikedIngredients",value:a.dislikedIngredients,onChange:V,placeholder:s("profile.dislikedIngredientsPlaceholder"),ref:k,"aria-invalid":!!t.dislikedIngredients,"aria-describedby":t.dislikedIngredients?"dislikedIngredients-error":"dislikedIngredients-helper"}),t.dislikedIngredients&&e.jsx("p",{id:"dislikedIngredients-error",className:"text-sm text-destructive",role:"alert",children:t.dislikedIngredients}),e.jsxs("p",{id:"dislikedIngredients-helper",className:"text-sm text-muted-foreground",children:[s("profile.dislikedIngredientsHelper")," ",e.jsx("strong",{className:"text-foreground",children:s("profile.dislikedIngredientsLanguageHint")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"preferredCuisines",children:s("profile.preferredCuisinesLabel")}),e.jsx(w,{name:"preferredCuisines",value:a.preferredCuisines,onChange:M,placeholder:s("profile.preferredCuisinesPlaceholder"),ref:b,"aria-invalid":!!t.preferredCuisines,"aria-describedby":t.preferredCuisines?"preferredCuisines-error":"preferredCuisines-helper"}),t.preferredCuisines&&e.jsx("p",{id:"preferredCuisines-error",className:"text-sm text-destructive",role:"alert",children:t.preferredCuisines}),e.jsxs("p",{id:"preferredCuisines-helper",className:"text-sm text-muted-foreground",children:[s("profile.preferredCuisinesHelper")," ",e.jsx("strong",{className:"text-foreground",children:s("profile.preferredCuisinesLanguageHint")})]})]}),!P&&e.jsx("div",{className:"text-sm text-destructive",role:"alert","aria-live":"polite",children:s("profile.atLeastOneFieldRequired")}),e.jsx(re,{type:"submit",disabled:!H,className:"w-full","aria-label":s(f?"common.saving":i==="create"?"profile.createButton":"profile.saveButton"),children:s(f?"common.saving":i==="create"?"profile.createButton":"profile.saveButton")})]})]})})}function ge(){const{data:r,isLoading:i,error:n}=Y(),a=G(),c=X(),t=r?"update":"create",l=r?de(r):oe();if(i)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(T,{className:"h-12 w-full"}),e.jsx(T,{className:"h-12 w-full"}),e.jsx(T,{className:"h-12 w-full"}),e.jsx(T,{className:"h-10 w-32"})]});const f=async x=>{try{if(t==="create"){const s=ce(x);console.log("[ProfileView] Creating profile with command:",s),await a.mutateAsync(s),j.success("Profile created successfully!")}else{const s=ue(x,l);if(console.log("[ProfileView] Updating profile with command:",s),console.log("[ProfileView] Current values:",x),console.log("[ProfileView] Initial values:",l),Object.keys(s).length===0){j.info("No changes to save");return}await c.mutateAsync(s),j.success("Profile updated successfully!")}}catch(s){const m=s;if(m.error==="Conflict"){j.error("Profile already exists. Please refresh the page.");return}if(m.error==="Bad Request"||m.message==="Validation failed"){j.error(m.message||"Validation error. Please check your input.");return}j.error(m.message||"An error occurred. Please try again.")}};if(n&&n.error!=="Not Found")return e.jsxs(_,{variant:"destructive",children:[e.jsx(A,{className:"h-4 w-4"}),e.jsx(E,{children:"Error"}),e.jsx(R,{children:n.message||"Failed to load profile. Please try again."})]});const h=a.isPending||c.isPending;return e.jsxs("div",{className:"space-y-6",children:[t==="create"&&e.jsxs(_,{children:[e.jsx(A,{className:"h-4 w-4"}),e.jsx(E,{children:"Create Your Profile"}),e.jsx(R,{children:"Set up your dietary preferences to get personalized recipe recommendations."})]}),e.jsx(me,{initialValues:l,mode:t,onSubmit:f}),h&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Saving..."})]})}function Te(){const[r,i]=u.useState(null);return u.useEffect(()=>{D.auth.getSession().then(({data:{session:a}})=>{i(a?.access_token??null)});const{data:{subscription:n}}=D.auth.onAuthStateChange((a,c)=>{i(c?.access_token??null)});return()=>n.unsubscribe()},[]),e.jsx(ee,{authToken:r,children:e.jsxs(J,{children:[e.jsx(ge,{}),e.jsx(W,{})]})})}export{Te as default};
