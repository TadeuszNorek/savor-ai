import{j as e}from"./createLucideIcon.Dkxjm4wi.js";import{S as M,c as z,d as O,e as U,f as S,B as $,X as q,o as K,q as Q,r as Y,g as k,t as j,p as G,T as H}from"./sonner.Ba-_p20Y.js";import{r as p}from"./index.BkdHoFEG.js";import{B as W}from"./supabase.client.D2OLuBHL.js";import{I as X,C as J,a as Z,b as ee,c as re,d as ie,L as w,A as D,e as A,g as E,f as R}from"./label.CRoT3Fms.js";import"./Combination.BffOO78u.js";import"./index.yjdR7O-I.js";function se(r){return{dietType:r.diet_type??null,dislikedIngredients:r.disliked_ingredients??[],preferredCuisines:r.preferred_cuisines??[]}}function te(){return{dietType:null,dislikedIngredients:[],preferredCuisines:[]}}function ne(r){const i={};return r.dietType&&(i.diet_type=r.dietType),r.dislikedIngredients.length>0&&(i.disliked_ingredients=r.dislikedIngredients),r.preferredCuisines.length>0&&(i.preferred_cuisines=r.preferredCuisines),i}function ae(r,i){const t={};return r.dietType!==i.dietType&&(t.diet_type=r.dietType),v(r.dislikedIngredients,i.dislikedIngredients)||(t.disliked_ingredients=r.dislikedIngredients),v(r.preferredCuisines,i.preferredCuisines)||(t.preferred_cuisines=r.preferredCuisines),t}function _(r){const i=r.map(t=>t.trim().toLowerCase()).filter(t=>t.length>0);return Array.from(new Set(i))}function V(r){return r.dietType!==null||r.dislikedIngredients.length>0||r.preferredCuisines.length>0}function de(r,i){return r.dietType!==i.dietType||!v(r.dislikedIngredients,i.dislikedIngredients)||!v(r.preferredCuisines,i.preferredCuisines)}function v(r,i){if(r.length!==i.length)return!1;const t=[...r].sort(),n=[...i].sort();return t.every((c,s)=>c===n[s])}const le=[{value:"vegan",label:"Vegan"},{value:"vegetarian",label:"Vegetarian"},{value:"pescatarian",label:"Pescatarian"},{value:"keto",label:"Keto"},{value:"paleo",label:"Paleo"},{value:"gluten_free",label:"Gluten Free"},{value:"dairy_free",label:"Dairy Free"},{value:"low_carb",label:"Low Carb"},{value:"mediterranean",label:"Mediterranean"},{value:"omnivore",label:"Omnivore"}],F=p.forwardRef(({value:r,onChange:i,"aria-invalid":t,"aria-describedby":n},c)=>{const s=a=>{i(a==="none"?null:a)};return e.jsxs(M,{value:r||"none",onValueChange:s,children:[e.jsx(z,{id:"dietType",className:"w-full",ref:c,"aria-invalid":t,"aria-describedby":n,children:e.jsx(O,{placeholder:"Select a diet type"})}),e.jsxs(U,{children:[e.jsx(S,{value:"none",children:"None"}),le.map(a=>e.jsx(S,{value:a.value,children:a.label},a.value))]})]})});F.displayName="DietTypeSelect";const N=p.forwardRef(({name:r,value:i,onChange:t,placeholder:n,"aria-invalid":c,"aria-describedby":s},a)=>{const[u,y]=p.useState(""),g=d=>{const h=d.trim();if(h.length===0||h.length>50)return;const C=h.toLowerCase();if(i.some(I=>I.toLowerCase()===C)){y("");return}t([...i,C]),y("")},o=d=>{t(i.filter((h,C)=>C!==d))},m=d=>{d.key==="Enter"||d.key===","?(d.preventDefault(),g(u)):d.key==="Backspace"&&u===""&&i.length>0&&o(i.length-1)},T=()=>{u.trim()&&g(u)},b=i.length>=100;return e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{id:r,type:"text",value:u,onChange:d=>y(d.target.value),onKeyDown:m,onBlur:T,placeholder:b?"Maximum limit reached":n,disabled:b,className:"w-full",ref:a,"aria-invalid":c,"aria-describedby":s,role:"textbox","aria-label":`Add ${r==="dislikedIngredients"?"disliked ingredients":"preferred cuisines"}`}),i.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",role:"list","aria-label":"Selected items",children:i.map((d,h)=>e.jsxs($,{variant:"secondary",className:"gap-1 pl-2 pr-1",role:"listitem",children:[e.jsx("span",{children:d}),e.jsx("button",{type:"button",onClick:()=>o(h),className:"ml-1 hover:bg-muted rounded-sm p-0.5","aria-label":`Remove ${d}`,children:e.jsx(q,{className:"h-3 w-3","aria-hidden":"true"})})]},`${d}-${h}`))}),e.jsxs("p",{className:"text-xs text-muted-foreground","aria-live":"polite",children:["Press Enter or comma to add. ",i.length,"/100 items."]})]})});N.displayName="TagsInput";function oe({initialValues:r,mode:i,onSubmit:t}){const[n,c]=p.useState(r),[s,a]=p.useState({}),[u,y]=p.useState(!1),g=p.useRef(null),o=p.useRef(null),m=p.useRef(null),T=p.useRef(null);p.useEffect(()=>{c(r)},[r]);const b=()=>{const l={};if(!V(n))return l.dietType="At least one field must be filled",a(l),!1;n.dislikedIngredients.length>100&&(l.dislikedIngredients="Maximum 100 ingredients allowed");for(const f of n.dislikedIngredients)if(f.length>50){l.dislikedIngredients="Each ingredient must be 50 characters or less";break}n.preferredCuisines.length>100&&(l.preferredCuisines="Maximum 100 cuisines allowed");for(const f of n.preferredCuisines)if(f.length>50){l.preferredCuisines="Each cuisine must be 50 characters or less";break}return a(l),Object.keys(l).length===0},d=async l=>{if(l.preventDefault(),!b()){s.dietType?g.current?.focus():s.dislikedIngredients?o.current?.focus():s.preferredCuisines&&m.current?.focus();return}y(!0);try{await t(n)}finally{y(!1)}},h=l=>{c(f=>({...f,dietType:l})),a(f=>({...f,dietType:void 0}))},C=l=>{const f=_(l);c(x=>({...x,dislikedIngredients:f})),a(x=>({...x,dislikedIngredients:void 0}))},I=l=>{const f=_(l);c(x=>({...x,preferredCuisines:f})),a(x=>({...x,preferredCuisines:void 0}))},B=de(n,r),P=V(n),L=P&&(i==="create"||B)&&!u;return e.jsx("form",{onSubmit:d,ref:T,"aria-label":"Profile preferences form",children:e.jsxs(J,{children:[e.jsxs(Z,{children:[e.jsx(ee,{children:i==="create"?"Create Profile":"Edit Profile"}),e.jsx(re,{children:i==="create"?"Set up your dietary preferences to get started.":"Update your dietary preferences to refine your recommendations."})]}),e.jsxs(ie,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"dietType",children:"Diet Type (Optional)"}),e.jsx(F,{value:n.dietType,onChange:h,ref:g,"aria-invalid":!!s.dietType,"aria-describedby":s.dietType?"dietType-error":"dietType-helper"}),s.dietType&&e.jsx("p",{id:"dietType-error",className:"text-sm text-destructive",role:"alert",children:s.dietType}),e.jsx("p",{id:"dietType-helper",className:"text-sm text-muted-foreground",children:"Select your dietary preference to filter recipes accordingly."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"dislikedIngredients",children:"Disliked Ingredients (Optional)"}),e.jsx(N,{name:"dislikedIngredients",value:n.dislikedIngredients,onChange:C,placeholder:"Add ingredients you want to avoid...",ref:o,"aria-invalid":!!s.dislikedIngredients,"aria-describedby":s.dislikedIngredients?"dislikedIngredients-error":"dislikedIngredients-helper"}),s.dislikedIngredients&&e.jsx("p",{id:"dislikedIngredients-error",className:"text-sm text-destructive",role:"alert",children:s.dislikedIngredients}),e.jsx("p",{id:"dislikedIngredients-helper",className:"text-sm text-muted-foreground",children:"Recipes containing these ingredients will be blocked from saving."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"preferredCuisines",children:"Preferred Cuisines (Optional)"}),e.jsx(N,{name:"preferredCuisines",value:n.preferredCuisines,onChange:I,placeholder:"Add cuisines you enjoy...",ref:m,"aria-invalid":!!s.preferredCuisines,"aria-describedby":s.preferredCuisines?"preferredCuisines-error":"preferredCuisines-helper"}),s.preferredCuisines&&e.jsx("p",{id:"preferredCuisines-error",className:"text-sm text-destructive",role:"alert",children:s.preferredCuisines}),e.jsx("p",{id:"preferredCuisines-helper",className:"text-sm text-muted-foreground",children:"We'll prioritize recipes from these cuisines in your recommendations."})]}),!P&&e.jsx("div",{className:"text-sm text-destructive",role:"alert","aria-live":"polite",children:"Please fill in at least one field to save your profile."}),e.jsx(W,{type:"submit",disabled:!L,className:"w-full","aria-label":u?"Saving profile":i==="create"?"Create profile":"Save changes to profile",children:u?"Saving...":i==="create"?"Create Profile":"Save Changes"})]})]})})}function ce(){const{data:r,isLoading:i,error:t}=K(),n=Q(),c=Y(),s=r?"update":"create",a=r?se(r):te();if(i)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{className:"h-12 w-full"}),e.jsx(k,{className:"h-12 w-full"}),e.jsx(k,{className:"h-12 w-full"}),e.jsx(k,{className:"h-10 w-32"})]});const u=async g=>{try{if(s==="create"){const o=ne(g);console.log("[ProfileView] Creating profile with command:",o),await n.mutateAsync(o),j.success("Profile created successfully!")}else{const o=ae(g,a);if(console.log("[ProfileView] Updating profile with command:",o),console.log("[ProfileView] Current values:",g),console.log("[ProfileView] Initial values:",a),Object.keys(o).length===0){j.info("No changes to save");return}await c.mutateAsync(o),j.success("Profile updated successfully!")}}catch(o){const m=o;if(m.error==="Conflict"){j.error("Profile already exists. Please refresh the page.");return}if(m.error==="Bad Request"||m.message==="Validation failed"){j.error(m.message||"Validation error. Please check your input.");return}j.error(m.message||"An error occurred. Please try again.")}};if(t&&t.error!=="Not Found")return e.jsxs(D,{variant:"destructive",children:[e.jsx(A,{className:"h-4 w-4"}),e.jsx(E,{children:"Error"}),e.jsx(R,{children:t.message||"Failed to load profile. Please try again."})]});const y=n.isPending||c.isPending;return e.jsxs("div",{className:"space-y-6",children:[s==="create"&&e.jsxs(D,{children:[e.jsx(A,{className:"h-4 w-4"}),e.jsx(E,{children:"Create Your Profile"}),e.jsx(R,{children:"Set up your dietary preferences to get personalized recipe recommendations."})]}),e.jsx(oe,{initialValues:a,mode:s,onSubmit:u}),y&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Saving..."})]})}function xe(){return e.jsxs(G,{children:[e.jsx(ce,{}),e.jsx(H,{})]})}export{xe as default};
